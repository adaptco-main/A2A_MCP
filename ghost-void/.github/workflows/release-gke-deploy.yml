name: Release GKE Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Container image tag to deploy"
        required: true
        type: string
      namespace:
        description: "Kubernetes namespace"
        required: false
        default: "default"
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      namespace: ${{ steps.meta.outputs.namespace }}
    steps:
      - name: Validate required secrets
        env:
          MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
          MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
          GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
          GKE_CLUSTER_LOCATION: ${{ secrets.GKE_CLUSTER_LOCATION }}
        shell: bash
        run: |
          set -euo pipefail
          required=(
            MCP_ENDPOINT MCP_TOKEN
            GCP_PROJECT_ID GCP_WORKLOAD_IDENTITY_PROVIDER GCP_SERVICE_ACCOUNT
            GKE_CLUSTER_NAME GKE_CLUSTER_LOCATION
          )
          for key in "${required[@]}"; do
            if [ -z "${!key:-}" ]; then
              echo "::error title=Missing secret::${key} is required for release deployment."
              exit 1
            fi
          done

      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
            NAMESPACE="${{ inputs.namespace }}"
          else
            IMAGE_TAG="${GITHUB_REF_NAME}"
            NAMESPACE="default"
          fi
          echo "image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"
          echo "namespace=${NAMESPACE}" >> "${GITHUB_OUTPUT}"

      - name: Verify MCP CI readiness gate
        env:
          MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
          MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          response=$(curl -sS --fail-with-body \
            -X GET "${MCP_ENDPOINT}/cicd/status/${GITHUB_SHA}" \
            -H "Authorization: Bearer ${MCP_TOKEN}")
          echo "Readiness response: ${response}"
          echo "${response}" | grep -Eq '"ready"[[:space:]]*:[[:space:]]*true|"status"[[:space:]]*:[[:space:]]*"ready"' || {
            echo "::error title=Readiness gate failed::MCP status is not ready for ${GITHUB_SHA}."
            exit 1
          }

  deploy:
    runs-on: ubuntu-latest
    needs: [preflight]
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Fetch GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_CLUSTER_LOCATION }}

      - name: Deploy MCP to GKE
        env:
          IMAGE_REPOSITORY: ${{ secrets.GKE_IMAGE_REPOSITORY }}
          IMAGE_TAG: ${{ needs.preflight.outputs.image_tag }}
          NAMESPACE: ${{ needs.preflight.outputs.namespace }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${IMAGE_REPOSITORY:-}" ]; then
            echo "::error title=Missing secret::GKE_IMAGE_REPOSITORY is required."
            exit 1
          fi

          kubectl -n "${NAMESPACE}" set image deployment/mcp-server mcp-server="${IMAGE_REPOSITORY}:${IMAGE_TAG}" --record
          kubectl -n "${NAMESPACE}" rollout status deployment/mcp-server --timeout=300s

  notify:
    runs-on: ubuntu-latest
    needs: [preflight, deploy]
    if: always()
    steps:
      - name: Emit deployment result to MCP webhook
        env:
          MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
          MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
          MCP_WEBHOOK_SECRET: ${{ secrets.MCP_WEBHOOK_SECRET }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          IMAGE_TAG: ${{ needs.preflight.outputs.image_tag }}
          NAMESPACE: ${{ needs.preflight.outputs.namespace }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${MCP_ENDPOINT:-}" ]; then
            echo "MCP_ENDPOINT is not configured; skipping notification."
            exit 0
          fi

          CONCLUSION="failure"
          if [ "${DEPLOY_RESULT}" = "success" ]; then
            CONCLUSION="success"
          fi

          payload=$(cat <<JSON
          {
            "workflow_run": {
              "id": ${{ github.run_id }},
              "name": "${{ github.workflow }}",
              "status": "completed",
              "conclusion": "${CONCLUSION}",
              "head_sha": "${{ github.sha }}",
              "head_branch": "${{ github.ref_name }}",
              "html_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "event": "release_deploy",
              "run_number": ${{ github.run_number }}
            },
            "deployment": {
              "target": "gke",
              "image_tag": "${IMAGE_TAG}",
              "namespace": "${NAMESPACE}"
            }
          }
          JSON
          )

          SIG_HEADER=()
          if [ -n "${MCP_WEBHOOK_SECRET:-}" ]; then
            SIGNATURE=$(printf '%s' "$payload" | openssl dgst -sha256 -hmac "$MCP_WEBHOOK_SECRET" | awk '{print $NF}')
            SIG_HEADER=(-H "X-Hub-Signature-256: sha256=${SIGNATURE}")
          fi

          curl -sS --fail-with-body \
            --retry 3 \
            --retry-delay 3 \
            --retry-all-errors \
            -X POST "${MCP_ENDPOINT}/webhooks/github/actions" \
            -H "Authorization: Bearer ${MCP_TOKEN}" \
            -H "X-GitHub-Event: workflow_run" \
            -H "Content-Type: application/json" \
            "${SIG_HEADER[@]}" \
            -d "${payload}"
