============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP
plugins: anyio-4.12.1, asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 3 items

tests/test_mlops_ticker.py::TestMLOpsTicker::test_event_store_terminal_filtering FAILED [ 33%]
tests/test_mlops_ticker.py::TestMLOpsTicker::test_whatsapp_message_format FAILED [ 66%]
tests/test_mlops_ticker.py::TestMLOpsTicker::test_whatsapp_send_success PASSED [100%]

================================== FAILURES ===================================
_____________ TestMLOpsTicker.test_event_store_terminal_filtering _____________

self = <test_mlops_ticker.TestMLOpsTicker object at 0x0000020C112F25D0>

    async def test_event_store_terminal_filtering(self):
        """Verify that only terminal events trigger observers."""
        mock_observer = AsyncMock()
        mock_db = MagicMock()
        # Mock save to return input
        mock_db.save_artifact.side_effect = lambda x: x
    
        # Patch the module-level _db_manager in event_store
        with patch("orchestrator.event_store._db_manager", mock_db):
            store = PostgresEventStore(observers=[mock_observer])
    
            # 1. INIT -> No notification
            artifact_init = ModelArtifact(
                artifact_id="init-1",
                model_id="test",
                weights_hash="h1",
                embedding_dim=1,
                state=AgentLifecycleState.INIT,
                content="test"
            )
            await store.append_event(artifact_init)
            mock_observer.on_state_change.assert_not_called()
    
            # 2. CONVERGED -> Notification
            artifact_converged = ModelArtifact(
                artifact_id="init-1",
                model_id="test",
                weights_hash="h1",
                embedding_dim=1,
                state=AgentLifecycleState.CONVERGED,
                content="test",
                parent_artifact_id="init-1"
            )
>           await store.append_event(artifact_converged)

tests\test_mlops_ticker.py:42: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
orchestrator\event_store.py:27: in append_event
    self.logger.info(f"Event {saved_artifact.id} reached terminal state {state}. Notifying observers.")
                              ^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = ModelArtifact(artifact_id='init-1', type='model_artifact', content='test', timestamp='2026-02-16T14:13:30.757052', met...te.CONVERGED: 'CONVERGED'>, parent_artifact_id='init-1', agent_name='ModelRegistry', version='1.0.0', lora_config=None)
item = 'id'

    def __getattr__(self, item: str) -> Any:
        private_attributes = object.__getattribute__(self, '__private_attributes__')
        if item in private_attributes:
            attribute = private_attributes[item]
            if hasattr(attribute, '__get__'):
                return attribute.__get__(self, type(self))  # type: ignore
    
            try:
                # Note: self.__pydantic_private__ cannot be None if self.__private_attributes__ has items
                return self.__pydantic_private__[item]  # type: ignore
            except KeyError as exc:
                raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}') from exc
        else:
            # `__pydantic_extra__` can fail to be set if the model is not yet fully initialized.
            # See `BaseModel.__repr_args__` for more details
            try:
                pydantic_extra = object.__getattribute__(self, '__pydantic_extra__')
            except AttributeError:
                pydantic_extra = None
    
            if pydantic_extra and item in pydantic_extra:
                return pydantic_extra[item]
            else:
                if hasattr(self.__class__, item):
                    return super().__getattribute__(item)  # Raises AttributeError if appropriate
                else:
                    # this is the current error
>                   raise AttributeError(f'{type(self).__name__!r} object has no attribute {item!r}')
E                   AttributeError: 'ModelArtifact' object has no attribute 'id'

.venv\Lib\site-packages\pydantic\main.py:1026: AttributeError
________________ TestMLOpsTicker.test_whatsapp_message_format _________________

self = <test_mlops_ticker.TestMLOpsTicker object at 0x0000020C13EB3290>

    async def test_whatsapp_message_format(self):
        """Verify WhatsApp message formatting."""
        observer = WhatsAppEventObserver(channel_id="123", api_token="abc")
    
        artifact = ModelArtifact(
            artifact_id="verify-1",
            model_id="test-model",
            weights_hash="ver-hash-1234567890",
            embedding_dim=10,
            state=AgentLifecycleState.CONVERGED,
            content="verification content",
            metadata={"pipeline_id": "pip-1", "execution_id": "exec-1"}
        )
    
        body = observer._format_message(artifact)
        assert "[MODEL EVENT VERIFIED]" in body
        assert "pipeline: pip-1" in body
        assert "execution: exec-1" in body
>       assert "state: CONVERGED" in body
E       AssertionError: assert 'state: CONVERGED' in '[MODEL EVENT VERIFIED]\npipeline: pip-1\nexecution: exec-1\nstate: AgentLifecycleState.CONVERGED\nhash: ver-hash-123...\ntimestamp: 2026-02-16T14:13:30.893201'

tests\test_mlops_ticker.py:63: AssertionError
============================== warnings summary ===============================
schemas\database.py:6
  C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\schemas\database.py:6: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Base = declarative_base()

tests/test_mlops_ticker.py::TestMLOpsTicker::test_whatsapp_send_success
  C:\Users\eqhsp\.antigravity\A2A_MCP\A2A_MCP\orchestrator\whatsapp.py:37: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    response.raise_for_status()
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_mlops_ticker.py::TestMLOpsTicker::test_event_store_terminal_filtering
FAILED tests/test_mlops_ticker.py::TestMLOpsTicker::test_whatsapp_message_format
=================== 2 failed, 1 passed, 2 warnings in 0.86s ===================
