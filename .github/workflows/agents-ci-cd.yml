name: Agents CI/CD

on:
  push:
    branches: [main]
    paths:
      - "agents/**"
      - "orchestrator/**"
      - "schemas/**"
      - "frontend/**"
      - "tests/**"
      - "requirements.txt"
      - "pyproject.toml"
      - ".github/workflows/agents-ci-cd.yml"
      - ".github/workflows/agents-unit-tests.yml"
  pull_request:
    branches: [main]
    paths:
      - "agents/**"
      - "orchestrator/**"
      - "schemas/**"
      - "frontend/**"
      - "tests/**"
      - "requirements.txt"
      - "pyproject.toml"
      - ".github/workflows/agents-ci-cd.yml"
      - ".github/workflows/agents-unit-tests.yml"
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio

      - name: Compile check
        env:
          PYTHONDONTWRITEBYTECODE: "1"
        run: python -m compileall -q .

      - name: Run unit tests
        env:
          PYTHONDONTWRITEBYTECODE: "1"
        run: |
          pytest -q tests/test_full_pipeline.py tests/test_intent_engine.py tests/test_avatar_integration.py tests/test_game_model.py tests/test_webgl_integration.py tests/test_cicd_pipeline.py

  contract-artifacts:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pydantic

      - name: Generate SSOT schemas
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          from schemas.game_model import GameModel
          from schemas.model_artifact import ModelArtifact
          from schemas.world_model import WorldModel

          out = Path("build/contracts")
          out.mkdir(parents=True, exist_ok=True)
          (out / "game_model.schema.json").write_text(json.dumps(GameModel.model_json_schema(), indent=2), encoding="utf-8")
          (out / "model_artifact.schema.json").write_text(json.dumps(ModelArtifact.model_json_schema(), indent=2), encoding="utf-8")
          (out / "world_model.schema.json").write_text(json.dumps(WorldModel.model_json_schema(), indent=2), encoding="utf-8")
          PY

      - name: Upload contract artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-contracts
          path: build/contracts

  deploy-release-contracts:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    needs: contract-artifacts
    permissions:
      contents: write
    steps:
      - name: Download contract artifacts
        uses: actions/download-artifact@v4
        with:
          name: agent-contracts
          path: build/contracts

      - name: Upload contracts to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload "${{ github.event.release.tag_name }}" build/contracts/*.json --clobber

  notify-cicd-monitor:
    name: Notify CI/CD monitor
    runs-on: ubuntu-latest
    needs: [unit-tests, contract-artifacts]
    if: always()
    steps:
      - name: Emit workflow_run payload to MCP webhook
        env:
          MCP_ENDPOINT: ${{ secrets.MCP_ENDPOINT }}
          MCP_TOKEN: ${{ secrets.MCP_TOKEN }}
          MCP_WEBHOOK_SECRET: ${{ secrets.MCP_WEBHOOK_SECRET }}
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          CONTRACT_RESULT: ${{ needs.contract-artifacts.result }}
        shell: bash
        run: |
          if [ -z "$MCP_ENDPOINT" ]; then
            echo "MCP_ENDPOINT is not configured; skipping CI monitor notification."
            exit 0
          fi

          CONCLUSION="failure"
          if [ "$UNIT_RESULT" = "success" ] && [ "$CONTRACT_RESULT" = "success" ]; then
            CONCLUSION="success"
          fi

          payload=$(cat <<JSON
          {
            "workflow_run": {
              "id": ${{ github.run_id }},
              "name": "${{ github.workflow }}",
              "status": "completed",
              "conclusion": "${CONCLUSION}",
              "head_sha": "${{ github.sha }}",
              "head_branch": "${{ github.ref_name }}",
              "html_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "event": "${{ github.event_name }}",
              "run_number": ${{ github.run_number }}
            }
          }
          JSON
          )

          SIG_HEADER=()
          if [ -n "$MCP_WEBHOOK_SECRET" ]; then
            SIGNATURE=$(printf '%s' "$payload" | openssl dgst -sha256 -hmac "$MCP_WEBHOOK_SECRET" | awk '{print $NF}')
            SIG_HEADER=(-H "X-Hub-Signature-256: sha256=${SIGNATURE}")
          fi

          curl -sS --fail-with-body \
            --retry 3 \
            --retry-delay 3 \
            --retry-all-errors \
            -X POST "${MCP_ENDPOINT}/webhooks/github/actions" \
            -H "Authorization: Bearer ${MCP_TOKEN}" \
            -H "X-GitHub-Event: workflow_run" \
            -H "Content-Type: application/json" \
            "${SIG_HEADER[@]}" \
            -d "${payload}"
