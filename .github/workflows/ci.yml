name: Ghost-Void CI — ADK Gate Enforcement

on:
  pull_request:
    branches: [main]
  push:
    branches: [main, 'feature/**']

permissions:
  contents: read

env:
  CXX: g++
  CXXFLAGS: "-I./include -std=c++17 -Wall -Wextra"

# ───────────────────────────────────────────────────────────
# Gate G2 — Design & Schema Integrity
# ───────────────────────────────────────────────────────────
jobs:
  validate-schemas:
    name: "G2 · Validate ADK Schemas"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install validators
        run: pip install jsonschema check-jsonschema

      - name: Validate all ADK schemas are well-formed JSON
        run: |
          echo "::group::Schema files"
          for f in adk/schemas/*.json; do
            echo "  ✓ Validating $f"
            python -m json.tool "$f" > /dev/null
          done
          echo "::endgroup::"

      - name: Validate contracts_index.json
        run: python -m json.tool adk/contracts_index.json > /dev/null

      - name: Validate genesis_block.json
        run: python -m json.tool adk/genesis_block.json > /dev/null

      - name: Run schema validation script
        run: bash tools/validate-schemas.sh

      - name: Upload gate result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-g2-result
          path: gate-result-g2.json

  # ───────────────────────────────────────────────────────────
  # Gate G3 — C++ Engine Build & Test
  # ───────────────────────────────────────────────────────────
  build-engine:
    name: "G3 · Build & Test C++ Engine"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build engine
        run: |
          mkdir -p bin build
          make all

      - name: Run safety tests
        run: make test

      - name: Run engine tests
        run: make test_engine

      - name: Run Jurassic Pixels tests
        run: make test_jurassic

      - name: Generate gate result
        if: always()
        run: |
          STATUS=${{ job.status == 'success' && 'PASS' || 'FAIL' }}
          cat > gate-result-g3-engine.json <<EOF
          {
            "gate": "G3",
            "check_id": "ENGINE_BUILD_TEST",
            "status": "${STATUS}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "details": {
              "compiler": "g++ 13",
              "standard": "C++17",
              "tests": ["safety_test", "engine_test", "jurassic_pixels_test"]
            }
          }
          EOF

      - name: Upload gate result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-g3-engine-result
          path: gate-result-g3-engine.json

  # ───────────────────────────────────────────────────────────
  # Gate G3 — Python Lint & Agency Hub Tests
  # ───────────────────────────────────────────────────────────
  test-python:
    name: "G3 · Python Lint & Test"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install ruff numpy scikit-learn

      - name: Lint agency_hub
        run: |
          ruff check agency_hub/ --select E,F,W --ignore E501

      - name: Lint docling-pipeline (if present)
        run: |
          if [ -d "docling-pipeline" ]; then
            ruff check docling-pipeline/ --select E,F,W --ignore E501
          fi

      - name: Run Agency Hub learning routine
        run: |
          cd "$(git rev-parse --show-toplevel)"
          python -m agency_hub.learning_routine

      - name: Generate gate result
        if: always()
        run: |
          STATUS=${{ job.status == 'success' && 'PASS' || 'FAIL' }}
          cat > gate-result-g3-python.json <<EOF
          {
            "gate": "G3",
            "check_id": "PYTHON_LINT_TEST",
            "status": "${STATUS}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "details": {
              "linter": "ruff",
              "python_version": "3.12",
              "modules": ["agency_hub", "docling-pipeline"]
            }
          }
          EOF

      - name: Upload gate result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-g3-python-result
          path: gate-result-g3-python.json

  # ───────────────────────────────────────────────────────────
  # Gate G4 — Docker Build & Release Readiness
  # ───────────────────────────────────────────────────────────
  build-docker:
    name: "G4 · Docker Build Verification"
    runs-on: ubuntu-latest
    needs: [validate-schemas, build-engine, test-python]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: ghost-void:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate gate result
        if: always()
        run: |
          STATUS=${{ job.status == 'success' && 'PASS' || 'FAIL' }}
          cat > gate-result-g4.json <<EOF
          {
            "gate": "G4",
            "check_id": "RELEASE_READINESS",
            "status": "${STATUS}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "details": {
              "image_tag": "ghost-void:ci-${{ github.sha }}",
              "dockerfile": "Dockerfile"
            }
          }
          EOF

      - name: Upload gate result
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-g4-result
          path: gate-result-g4.json
