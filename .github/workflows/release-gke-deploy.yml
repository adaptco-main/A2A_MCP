name: Release GKE Deploy

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  staging-token-shaping-gates:
    name: Staging token-shaping gates
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Contract validation for required avatar fields
        run: pytest -q tests/test_release_token_shaping_gates.py::test_avatar_contract_requires_required_fields

      - name: Negative auth checks for token validation and repo mismatch
        run: |
          pytest -q \
            tests/test_release_token_shaping_gates.py::test_ingestion_rejects_missing_bearer_token \
            tests/test_release_token_shaping_gates.py::test_verify_token_rejects_bad_issuer_or_audience \
            tests/test_release_token_shaping_gates.py::test_ingestion_rejects_repository_claim_mismatch

      - name: Determinism check for shaped output/hash
        run: pytest -q tests/test_release_token_shaping_gates.py::test_token_shaping_is_deterministic_for_identical_input_stream

      - name: Smoke test for protected /tools/call path with production-like headers
        run: pytest -q tests/test_release_token_shaping_gates.py::test_tools_call_smoke_with_production_like_headers

  production-approval:
    name: Production approval (blocked until staging gates pass)
    runs-on: ubuntu-latest
    needs:
      - staging-token-shaping-gates
    if: ${{ needs.staging-token-shaping-gates.result == 'success' }}
    environment: production
    steps:
      - name: Confirm gate status
        run: echo "All staging token-shaping gates passed. Production approval is now unblocked."
