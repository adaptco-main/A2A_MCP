name: Release GKE Deploy

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy"
        required: true
        default: "latest"
  push:
    branches:
      - main

env:
  GAR_LOCATION: "us-central1"
  GKE_CLUSTER: "mcp-cluster"
  GKE_ZONE: "us-central1-c"
  DEPLOYMENT_NAME: "mcp-deployment"
  IMAGE_NAME: "mcp-core"
  WEBHOOK_URL: "https://your-webhook-url.com/post-deploy"

jobs:
  staging-token-shaping-gates:
    name: Staging token-shaping gates
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Contract validation for required avatar fields
        run: pytest -q tests/test_release_token_shaping_gates.py::test_avatar_contract_requires_required_fields

      - name: Negative auth checks for token validation and repo mismatch
        run: |
          pytest -q \
            tests/test_release_token_shaping_gates.py::test_ingestion_rejects_missing_bearer_token \
            tests/test_release_token_shaping_gates.py::test_verify_token_rejects_bad_issuer_or_audience \
            tests/test_release_token_shaping_gates.py::test_ingestion_rejects_repository_claim_mismatch

      - name: Determinism check for shaped output/hash
        run: pytest -q tests/test_release_token_shaping_gates.py::test_token_shaping_is_deterministic_for_identical_input_stream

      - name: Smoke test for protected /tools/call path with production-like headers
        run: pytest -q tests/test_release_token_shaping_gates.py::test_tools_call_smoke_with_production_like_headers

  build-and-push:
    name: "Build and Push to GAR"
    runs-on: ubuntu-latest
    needs: staging-token-shaping-gates
    permissions:
      contents: "read"
      id-token: "write"
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: "projects/${{ secrets.GCP_PROJECT_ID }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider"
          service_account: "github-actions@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Build and push to GAR"
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: "${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mcp-images/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag || 'latest' }}"

  deploy-to-gke:
    name: "Deploy to GKE"
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud"
        uses: "google-github-actions/auth@v2"
        with:
          workload_identity_provider: "projects/${{ secrets.GCP_PROJECT_ID }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider"
          service_account: "github-actions@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

      - name: "Set up GKE credentials"
        uses: "google-github-actions/get-gke-credentials@v2"
        with:
          cluster_name: "${{ env.GKE_CLUSTER }}"
          location: "${{ env.GKE_ZONE }}"

      - name: "Deploy to GKE"
        run: |
          kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} mcp-core=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mcp-images/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag || 'latest' }}

      - name: "Readiness Gate: Wait for deployment rollout"
        run: |
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=5m

      - name: "Post-deploy webhook"
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" -d '{"status": "success", "tag": "${{ github.event.inputs.image_tag || 'latest' }}"}' ${{ env.WEBHOOK_URL }}

  test-release-path:
    name: "Test Release Path"
    runs-on: ubuntu-latest
    needs: deploy-to-gke

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: "Install dependencies"
        run: |
          pip install -r requirements.txt
          pip install pytest requests

      - name: "Run release path tests"
        run: |
          echo "Running release path tests..."
          pytest tests/test_gke_release.py
