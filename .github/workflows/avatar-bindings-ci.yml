name: Avatar Bindings CI

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

jobs:
  validate-and-seal:
    name: "Validate & Seal"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Detect Node lockfiles
        id: node_lockfiles
        shell: bash
        run: |
          set -euo pipefail
          matches=$(find . -path '*/node_modules/*' -prune -o -name package-lock.json -print | sort)
          if [ -n "$matches" ]; then
            {
              echo "paths<<EOF"
              echo "$matches"
              echo "EOF"
            } >>"$GITHUB_OUTPUT"
            echo "Detected npm lockfiles:"
            echo "$matches"
          else
            echo "paths=" >>"$GITHUB_OUTPUT"
            echo "No npm lockfiles found; skipping dependency cache."
          fi

      - name: Setup Node.js (with npm cache)
        if: steps.node_lockfiles.outputs.paths != ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ steps.node_lockfiles.outputs.paths }}

      - name: Setup Node.js (without cache)
        if: steps.node_lockfiles.outputs.paths == ''
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install AJV CLI
        run: npm install -g ajv-cli

      - name: Install Python 3
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: pip install nacl

      - name: Schema-validate manifest
        run: ajv validate -s schemas/avatar_bindings.v1.schema.json -d avatar_bindings.v1.json --strict=true

      - name: Canonicalize manifest
        run: python3 scripts/canonicalize_manifest.py < avatar_bindings.v1.json > avatar_bindings.v1.canonical.json

      - name: Compute & Sign the hash
        env:
          MAKER_KEY: ${{ secrets.MAKER_ED25519_SEED }}
        run: ./scripts/sign_bindings.sh

      - name: Ledger-ACK Event
        run: |
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          HASH=$(cat avatar_bindings.v1.hash)
          MAKER_SIG=$(cat avatar_bindings.v1.maker.sig)
          jq -nc --arg ts "$TS" --arg hash "$HASH" --arg sig "$MAKER_SIG" '{ts:$ts, type:"avatar_bindings.sealed", hash:$hash, maker_sig:$sig}' >> events.ndjson

      - name: Upload sealed artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sealed-artifacts
          path: |
            avatar_bindings.v1.canonical.json
            avatar_bindings.v1.hash
            avatar_bindings.v1.maker.sig
            events.ndjson
          retention-days: 1

  commit-ledger-data:
    name: "Commit to Ledger"
    needs: validate-and-seal
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Download sealed artifacts
        uses: actions/download-artifact@v4
        with:
          name: sealed-artifacts

      - name: Prepare and move files
        run: |
          DATE_PATH=$(date -u +'%Y/%m/%d')
          mkdir -p "data/events/${DATE_PATH}"
          mv events.ndjson "data/events/${DATE_PATH}/events-${GITHUB_RUN_ID}.ndjson"
          mkdir -p "data/capsules"
          mv avatar_bindings.v1.canonical.json data/capsules/
          mv avatar_bindings.v1.hash data/capsules/
          mv avatar_bindings.v1.maker.sig data/capsules/

      - name: Commit sealed artifacts
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "feat(ledger): seal and log avatar bindings ${GITHUB_RUN_ID} [skip ci]"
          git push origin HEAD:main
