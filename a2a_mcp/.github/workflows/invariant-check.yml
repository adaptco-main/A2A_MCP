name: invariant-check

on:
  push:
  pull_request:

jobs:
  invariants:
    runs-on: ubuntu-latest
    env:
      AUTOMATION_OUTPUT_CHANNEL: pr
      HERMETIC_MODE: "true"
      NO_OUTBOUND_NETWORK: "true"
      ALLOW_OUTBOUND_NETWORK: "false"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install dependencies
        run: pip install .
      - name: Run locked invariants
        run: |
          set -euo pipefail
          mkdir -p artifacts
          python scripts/check_invariants.py \
            --registry manifests/invariant_registry.json \
            --output artifacts/invariant-results.json | tee artifacts/invariant-results.log
      - name: Emit invariant verdict summary
        if: always()
        run: |
          set -euo pipefail
          if [ -f artifacts/invariant-results.json ]; then
            python - <<'PY'
import json
from pathlib import Path
results = json.loads(Path('artifacts/invariant-results.json').read_text())
for item in results:
    print(f"INVARIANT id={item['invariant_id']} verdict={item['verdict']} hard_fail={item['hard_fail']}")
PY
          fi
      - name: Upload invariant audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: invariant-results
          path: artifacts/
